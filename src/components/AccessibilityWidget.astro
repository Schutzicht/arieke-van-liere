---
interface Props {
    alignment?: 'right' | 'center';
}
const { alignment = 'right' } = Astro.props;

// If centered (mobile), use fixed positioning to act as a modal
const positionClasses = alignment === 'center' 
    ? 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 mt-0 z-[100] w-[90vw] max-w-sm shadow-[0_0_0_1000px_rgba(0,0,0,0.5)]' 
    : 'absolute right-0 top-full origin-top-right mt-2 w-64 shadow-xl z-50';
---

<div class="a11y-widget relative group z-50 font-sans">
    <!-- Toggle Button -->
    <button class="a11y-trigger w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-brand-green/50" aria-label="Toegankelijkheidsopties" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
            <circle cx="12" cy="5" r="1" />
            <path d="m9 20 3-6 3 6" />
            <path d="m6 8 6 2 6-2" />
            <path d="M12 10v4" />
        </svg>
    </button>

    <!-- Menu (Dropdown) -->
    <div class:list={["a11y-menu bg-white rounded-2xl border border-gray-100 overflow-hidden transform transition-all duration-200 scale-95 opacity-0 invisible pointer-events-none", positionClasses]}>
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-gray-900 text-xs uppercase tracking-wider">Toegankelijkheid</h3>
             <button class="close-a11y text-gray-400 hover:text-gray-700">
                <span class="sr-only">Sluiten</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="p-2 space-y-1">
            <!-- Contrast Toggle -->
            <button class="toggle-contrast w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10V2z"></path></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-700">Contrast</span>
                </div>
                <div class="w-10 h-5 bg-gray-200 rounded-full relative transition-colors toggle-track">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform toggle-thumb shadow-sm"></div>
                </div>
            </button>

            <!-- Text Size Toggle -->
            <button class="toggle-text w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19V5h6m7 14V9h-6"></path></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-700">Tekstgrootte</span>
                </div>
                <div class="w-10 h-5 bg-gray-200 rounded-full relative transition-colors toggle-track">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform toggle-thumb shadow-sm"></div>
                </div>
            </button>

            <!-- Motion Toggle -->
            <button class="toggle-motion w-full flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                    </div>
                    <span class="text-sm font-medium text-gray-700">Stop Animatie</span>
                </div>
                <div class="w-10 h-5 bg-gray-200 rounded-full relative transition-colors toggle-track">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform toggle-thumb shadow-sm"></div>
                </div>
            </button>
        </div>
    </div>
</div>

<script>
    // Global Accessibilty State
    const globalState = {
        contrast: localStorage.getItem('a11y_contrast') === 'true',
        text: localStorage.getItem('a11y_text') === 'true',
        motion: localStorage.getItem('a11y_motion') === 'true',
    };

    function updateGlobalStyles() {
        document.documentElement.classList.toggle('a11y-high-contrast', globalState.contrast);
        document.documentElement.classList.toggle('a11y-large-text', globalState.text);
        document.documentElement.classList.toggle('a11y-reduced-motion', globalState.motion);
    }

    // Initialize global styles immediately
    updateGlobalStyles();

    // Helper for visual toggles
    function updateToggleVisual(btn, isActive) {
        if (!btn) return;
        const track = btn.querySelector('.toggle-track');
        const thumb = btn.querySelector('.toggle-thumb');

        if (isActive) {
            track?.classList.add('bg-brand-green');
            track?.classList.remove('bg-gray-200');
            thumb?.classList.add('translate-x-5');
        } else {
            track?.classList.remove('bg-brand-green');
            track?.classList.add('bg-gray-200');
            thumb?.classList.remove('translate-x-5');
        }
    }

    // Initialize all widgets
    document.querySelectorAll('.a11y-widget').forEach(widget => {
        const trigger = widget.querySelector('.a11y-trigger');
        const menu = widget.querySelector('.a11y-menu');
        const closeBtn = widget.querySelector('.close-a11y');
        const toggleContrast = widget.querySelector('.toggle-contrast');
        const toggleText = widget.querySelector('.toggle-text');
        const toggleMotion = widget.querySelector('.toggle-motion');

        let menuOpen = false;

        function updateWidgetUI() {
            // Apply global state to local toggles
            updateToggleVisual(toggleContrast, globalState.contrast);
            updateToggleVisual(toggleText, globalState.text);
            updateToggleVisual(toggleMotion, globalState.motion);

            // Menu state
            if (menuOpen) {
                menu?.classList.remove('invisible', 'pointer-events-none', 'scale-95', 'opacity-0');
                menu?.classList.add('visible', 'pointer-events-auto', 'scale-100', 'opacity-100');
                trigger?.classList.add('bg-gray-200');
                trigger?.setAttribute('aria-expanded', 'true');
            } else {
                menu?.classList.add('invisible', 'pointer-events-none', 'scale-95', 'opacity-0');
                menu?.classList.remove('visible', 'pointer-events-auto', 'scale-100', 'opacity-100');
                trigger?.classList.remove('bg-gray-200');
                trigger?.setAttribute('aria-expanded', 'false');
            }
        }

        // Event Listeners
        trigger?.addEventListener('click', (e) => {
            e.stopPropagation();
            // Close other open widgets first if any (optional, but good UX)
            // For now, standalone state is fine.
            menuOpen = !menuOpen;
            updateWidgetUI();
        });

        closeBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            menuOpen = false;
            updateWidgetUI();
        });

        // Toggle Actions (Updates Global State)
        toggleContrast?.addEventListener('click', () => {
            globalState.contrast = !globalState.contrast;
            localStorage.setItem('a11y_contrast', String(globalState.contrast));
            updateGlobalStyles();
            // Update ALL widgets to reflect change
            document.querySelectorAll('.a11y-widget').forEach(w => {
                // Re-run updateWidgetUI for each found widget to sync toggle visuals
                // We can't easily call the closure function, so we might need a simpler way or custom event.
                // Simpler approach: Manually update visuals for all widgets here:
                const tC = w.querySelector('.toggle-contrast');
                updateToggleVisual(tC, globalState.contrast);
            });
        });

        toggleText?.addEventListener('click', () => {
             globalState.text = !globalState.text;
            localStorage.setItem('a11y_text', String(globalState.text));
            updateGlobalStyles();
            document.querySelectorAll('.a11y-widget').forEach(w => {
                const tT = w.querySelector('.toggle-text');
                updateToggleVisual(tT, globalState.text);
            });
        });

        toggleMotion?.addEventListener('click', () => {
            globalState.motion = !globalState.motion;
            localStorage.setItem('a11y_motion', String(globalState.motion));
            updateGlobalStyles();
            document.querySelectorAll('.a11y-widget').forEach(w => {
                const tM = w.querySelector('.toggle-motion');
                updateToggleVisual(tM, globalState.motion);
            });
        });

        // Click Outside
        document.addEventListener('click', (e) => {
            if (menuOpen && !menu?.contains(e.target) && !trigger?.contains(e.target)) {
                menuOpen = false;
                updateWidgetUI();
            }
        });

        // Initial setup
        updateWidgetUI();
    });
</script>
